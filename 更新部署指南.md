# VoiceRAG 更新部署指南

## 当前情况

您的代码已在本地更新（包含 v2.1.0 版本号、智能回答模式、英语锁定），但 Azure 上的应用还是旧版本（10/22 部署的）。

需要将最新代码更新到 Azure 上。

---

## 方法 1: 使用 Azure Portal 手动更新（推荐，最可靠）

### 步骤 1: 准备更新文件

**在命令行中运行：**

```bash
# 1. 进入前端目录并构建
cd app\frontend
npm run build

# 2. 回到项目根目录
cd ..\..

# 3. 创建部署包
powershell -Command "Compress-Archive -Path 'app\*' -DestinationPath 'voicerag-latest.zip' -Force"
```

### 步骤 2: 在 Azure Portal 中更新

1. **登录 Azure Portal**：https://portal.azure.com

2. **找到 Container App**：
   - 搜索：`capps-backend-bgvscddssk7zk`
   - 点击进入

3. **创建新修订版本**：
   - 左侧菜单 → **Revisions**
   - 点击 **"Create new revision"** 按钮

4. **选择上传方式**：
   - 选择 **"Upload artifact"**
   - 点击 **"Browse"** 选择 `voicerag-latest.zip`
   - 点击 **"Upload"**

5. **配置修订版本**：
   - **Name/suffix**：留空或输入 `v2-1-0`
   - **Image source**：Upload artifact
   - 其他保持默认

6. **创建并应用**：
   - 点击 **"Create"** 按钮
   - 等待修订版本创建完成（3-5分钟）
   - 创建完成后，点击 **"Apply"** 应用新版本

---

## 方法 2: 使用命令行完整部署

### 准备工作

**打开一个新的 PowerShell 窗口**（不要在当前的命令行中运行）

### 执行部署

```powershell
# 1. 进入项目目录
cd "D:\工作\infinite social\voice agent\aisearch-openai-rag-audio"

# 2. 构建前端
cd app\frontend
npm run build
cd ..\..

# 3. 部署到 Azure（让这个命令完整运行，不要中断）
azd deploy --service backend
```

**重要**：
- 让部署命令完整运行（通常需要 3-5 分钟）
- 不要按任何键中断
- 等待看到 "SUCCESS" 消息

---

## 方法 3: 直接使用 Azure CLI

如果 azd 部署有问题，可以直接使用 Azure CLI：

```bash
# 1. 登录 Azure
az login

# 2. 检查当前镜像
az containerapp show --name capps-backend-bgvscddssk7zk --resource-group rg-voicerag-prod --query "properties.template.containers[0].image"

# 3. 更新容器（需要先构建并推送新镜像）
az containerapp update \
  --name capps-backend-bgvscddssk7zk \
  --resource-group rg-voicerag-prod \
  --image voiceragprodacrbgvscddssk7zk.azurecr.io/voicerag:latest
```

---

## 验证更新成功

### 1. 在 Azure Portal 中检查

**Revisions 页面：**
- 应该看到新的 revision（今天的日期）
- 状态应该是 "Active"
- 流量权重应该是 100%

**Overview 页面：**
- "Last modified time" 应该是最近的时间
- "Provisioning state" 应该是 "Succeeded"



### 2. 在应用中检查

**访问应用**：
https://capps-backend-bgvscddssk7zk.gentleisland-734d3c33.brazilsouth.azurecontainerapps.io/

**检查项：**
- [ ] 页面右下角显示 "v2.1.0" 版本号
- [ ] 清除浏览器缓存后仍显示版本号
- [ ] 使用无痕模式访问也能看到版本号

### 3. 测试新功能

**测试智能回答模式：**
- 问一个知识库外的问题（如："What's the capital of France?"）
- Agent 应该用 GPT 知识回答，而不是说"不知道"

**测试英语锁定：**
- 进行长时间对话（5-10分钟）
- 确认 Agent 始终用英语回答
- 不会切换到西班牙语

---

## 常见问题

### Q: 为什么部署总是被中断？

**A**: 可能是：
- 命令行窗口设置问题
- 网络连接不稳定
- 构建时间太长触发超时

**解决方法**：
- 使用新的 PowerShell 窗口
- 使用 Azure Portal 手动更新
- 检查网络连接稳定性

### Q: 如何确认部署真的完成了？

**A**: 查看三个地方：
1. **Azure Portal Revisions** - 有新的 revision
2. **应用页面** - 显示版本号 v2.1.0
3. **功能测试** - 新功能正常工作

### Q: 部署失败了怎么办？

**A**: 检查：
1. Azure Portal → Container App → Logs（日志）
2. 查看错误信息
3. 检查资源配额是否充足
4. 验证网络连接

---

## 推荐的更新步骤

**最简单可靠的方法：**

1. **打开新的 PowerShell 窗口**

2. **运行以下命令：**
```powershell
cd "D:\工作\infinite social\voice agent\aisearch-openai-rag-audio"
cd app\frontend
npm run build
cd ..\..
azd deploy --service backend
```

3. **等待完成**（不要中断，大约 5 分钟）

4. **验证**：
   - 访问应用链接
   - 检查版本号
   - 测试新功能

---

**如果命令行方法仍有问题，请使用 Azure Portal 的方法 1**，这是最可靠的方式。

您想尝试哪种方法？











