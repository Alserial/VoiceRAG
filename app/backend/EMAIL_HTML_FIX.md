# 邮件显示 HTML 源代码的解决方案

## 问题描述

收到的邮件正文显示为 HTML 源代码，而不是渲染后的 HTML 内容。

## 可能的原因

1. **邮件客户端设置**：某些邮件客户端默认以纯文本模式显示邮件
2. **Salesforce emailSimple API 限制**：可能没有正确设置 Content-Type 为 text/html
3. **邮件客户端不支持 HTML**：某些邮件客户端可能不完全支持 HTML 邮件

## 解决方案

### 方案 1：检查邮件客户端设置（推荐）

#### Gmail
1. 打开 Gmail
2. 点击右上角设置图标
3. 选择"查看所有设置"
4. 在"常规"标签中，确保"邮件显示"设置为"默认"
5. 保存更改

#### Outlook
1. 打开 Outlook
2. 文件 → 选项 → 邮件
3. 在"撰写邮件"部分，确保"使用此格式撰写邮件"设置为"HTML"
4. 确定

#### 其他邮件客户端
- 查找邮件显示格式设置
- 确保设置为"HTML"或"富文本"模式

### 方案 2：在邮件客户端中查看原始邮件

如果邮件客户端支持，可以：
1. 查看邮件的原始源代码
2. 检查 `Content-Type` 是否为 `text/html`
3. 如果 Content-Type 不正确，这是 Salesforce API 的问题

### 方案 3：使用不同的邮件服务（如果问题持续）

如果 Salesforce 的 emailSimple API 无法正确发送 HTML 邮件，可以考虑：

1. **使用 Azure Communication Services Email**
   - 更好的 HTML 支持
   - 更可靠的送达率

2. **使用 SMTP 服务**
   - 直接控制邮件格式
   - 更好的 HTML 支持

## 已做的改进

我已经优化了 HTML 模板：
- 移除了多余的缩进和换行
- 确保 HTML 格式正确
- 清理了 HTML 结构

## 测试步骤

1. 重新发送测试邮件
2. 检查新邮件是否正常显示 HTML
3. 如果仍然显示源代码：
   - 检查邮件客户端设置
   - 尝试使用不同的邮件客户端
   - 查看邮件的原始源代码

## 临时解决方案

如果邮件客户端无法正确显示 HTML，可以：
1. 复制邮件中的链接
2. 在浏览器中打开链接查看报价
3. 或者使用纯文本版本的邮件（需要修改代码）

## 相关文件

- `app/backend/email_service.py` - 邮件发送服务
- `app/backend/EMAIL_TROUBLESHOOTING.md` - 邮件问题排查指南

